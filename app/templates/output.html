{% extends 'base.html' %}

{% block title %}Course Recommendations{% endblock %}

{% block content %}
<style>
    .content-background {
        background: url('{{ url_for('static', filename='images/undraw_trip_dv9f.svg') }}') no-repeat center center;
        background-size: 85%; /* Adjust the percentage to make the image smaller */
    }
    .chat-background {
        background: url('{{ url_for('static', filename='images/undraw_text_field_htlv.svg') }}') no-repeat center center;
        background-size: 85%; /* Adjust the percentage to make the image smaller */
    }
    .content-container {
        min-height: calc(100vh - 3rem);; /* Full height */
        display: flex;
        flex-direction: column;
    }
    .card-header {
        background-color: #f0f0f0;
        font-weight: bold;
    }
    .card {
        border: none;
        transition: transform 0.5s;
    }
    .card-hover:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    .confidence-rating {
        font-size: 0.9em;
        color: #28a745; /* Bootstrap success color */
    }
    .container-pane, .chat-pane{
        transition: transform 0.5s ease-in-out; /* Slower transition */
    }
    .container-pane {
        transform: translateX(0);
    }
    .chat-pane {
        width: 40%; /* Half screen width */
        position: fixed;
        top: 0;
        right: -40%; /* Adjusted to match new width */
        height: 100vh;
        overflow-y: auto;
        z-index: 1030; /* Slightly less than the navbar z-index */
        padding-top: 1em;
        padding-bottom: 1em;
        padding-right: 1em;
    }
    .chat-header {
        padding: 0.5rem 1rem; /* Padding for header content */
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-radius: 0.25rem;
        font-weight: bold;
    }
    .chat-header button {
        background: none;
        border: none;
        font-size: 1.5rem;
    }
    .chat-container {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 50px); /* Adjusted to account for the added margin */
        border: 1px solid #ccc;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        background-color: #fff;
        overflow: hidden;
    }
    .chat-area {
        padding: 10px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        flex-grow: 1;
        align-items: flex-start; /* Align items to the start/left by default */
    }
    .message {
        display: inline-block; /* Make the bubble only as wide as the content */
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 15px;
        word-wrap: break-word; /* Ensure long words do not break the layout */
    }
    .user-message {
        background-color: #dcf8c6;
        margin-right: auto; /* Keep messages on the left */
    }
    .bot-message {
        background-color: #e5e5ea;
        margin-left: auto; /* Keep messages on the right */
    }
    .show-chat {
        transform: translateX(-45%); /* Adjusted to match new width */
        transition: transform 0.5s ease-in-out;
    }
    .show-chat-pane {
        transform: translateX(-100%); /* Adjusted to match new width */
        transition: transform 0.5s ease-in-out;
    }
    /* Ensure the navbar has a higher z-index */
    .navbar {
        z-index: 1040; /* This should be higher than the chat pane */
    }
    
</style>

<!-- Main content container -->
<div class="container mt-5 content-background content-container container-pane">
    <h1 class="text-center mb-5 display-4">Top Course Recommendations</h1>

    <div class="row mb-4 justify-content-center">
        <div class="col-lg-6 mb-3">
            <div class="card h-100 shadow">
                <div class="card-body d-flex align-items-center justify-content-center text-center">
                    <p class="lead">
                        These are your recommendations based on your interests and past performance.
                        Click on a course to chat with your assistant and learn more about it.
                        You could for example ask us why we recommend this course for you.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div class="row justify-content-center">
        {% for course in courses %}
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card card-hover h-100 shadow" onclick="openChat('{{ course.title }}')">
                <div class="card-header">{{ course.title }}</div>
                <div class="card-body ">
                    <p class="card-text">{{ course.description }}</p>
                </div>
                <div class="card-footer bg-white">
                    <span class="confidence-rating">Confidence: {{ course.similarity * 100 }}%</span>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    <!-- Button for the survey -->
    <!-- Centered and larger button for the survey -->
    <div class="row justify-content-center mt-4">
        <div class="col-lg-6 text-center mb-4">
            <a class="btn btn-primary btn-lg" href="{{ url_for('survey') }}" role="button">Take the Survey</a>
        </div>
    </div>
</div>


<!-- Chatbot interface panel -->
<div class="chat-pane card" id="chatPane">
    <div class="chat-header card-header">
        <div id="chatCourseName">
            Chat with your Assistant
        </div>
        <button onclick="closeChat()">Ã—</button>
    </div>
    <div class="chat-container card-body chat-background">
        <div class="chat-area" id="chatArea">
            <!-- Messages will be dynamically inserted here -->
        </div>
        <div class="input-group input-container">
            <input type="text" class="form-control" placeholder="Ask me something..." name="input_text" id="userInput" required>
            <button type="submit" onclick="sendChat()" class="btn btn-outline-secondary">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
</h3>

<script>
    function openChat(courseName) {
        document.querySelector('.container-pane').classList.add('show-chat');
        document.querySelector('.chat-pane').classList.add('show-chat-pane');
        document.getElementById('chatCourseName').innerText = "Chat about " + courseName; // If you want to display the course name in the chat pane
    }

    function closeChat() {
        document.querySelector('.container-pane').classList.remove('show-chat');
        document.querySelector('.chat-pane').classList.remove('show-chat-pane');
    }

    async function sendChat() {
        let userInput = document.getElementById("userInput").value.trim();
        if (!userInput) return; // Don't send empty messages

        // Add user's message to the chat area
        appendMessage(userInput, 'user');

        // Clear input after sending
        document.getElementById("userInput").value = '';

        try {
            // Start the POST request to send the message
            const response = await fetch('/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ message: userInput })
            });

            let reader = response.body.getReader();
            let decoder = new TextDecoder();

            // Create bot message
            botMessageContainer = appendMessage('bot-message', 'bot', reader, decoder);

            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                let chunk = decoder.decode(value, { stream: true });
                // Replace newline characters with HTML <br> tags
                chunk = chunk.replace(/\n/g, '<br>');
                botMessageContainer.textContent += chunk;
            }
            document.getElementById('chatArea').appendChild(botMessageContainer);
            // Scroll the bot's message container into view
            botMessageContainer.scrollIntoView({ behavior: 'smooth' });

        } catch (error) {
            console.error('Error:', error);
            appendMessage("Sorry, I can't connect to the chat service right now.", 'bot');
        }
    }

    function appendMessage(text, sender) {
        let messageContainer = document.createElement('div');
        messageContainer.classList.add('message');

        if (sender === 'user') {
            messageContainer.classList.add('user-message');

            messageContainer.textContent = text; // Use textContent for better security
            document.getElementById('chatArea').appendChild(messageContainer);
            messageContainer.scrollIntoView({ behavior: 'smooth' });
        } else if (sender === 'bot') {
            messageContainer.classList.add('bot-message');
            // For bot messages, we need to change the alignment to the end/right
            messageContainer.style.alignSelf = 'flex-end';
            return messageContainer;
        }
    }

</script>

{% endblock %}
